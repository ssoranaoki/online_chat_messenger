# オンラインチャットメッセンジャー

リアルタイムチャット機能を提供するクライアント・サーバー型のメッセージングシステムです。複数のユーザーが管理されたチャットルームで通信できます。

## システム概要

このプロジェクトは、ユーザーがグループ会話に参加できるリアルタイムチャットメッセンジャーシステムです。ユーザーは以下のことができます：

- **チャットルーム作成**: 新しいチャットルームを作成し、管理者権限を持つホストになる
- **既存ルーム参加**: 他のユーザーが作成したアクティブなチャットルームに参加する
- **リアルタイムメッセージング**: ルーム内の他の参加者と即座にメッセージを送受信する
- **ルーム管理**: ルームホストはルームを閉じることができ、任意のユーザーはいつでも退出可能

## アーキテクチャ

システムはクライアント・サーバーアーキテクチャを採用し、複数のクライアントアプリケーションが中央サーバーに接続してルーム状態とメッセージ中継を管理します。

### デュアルプロトコル設計

システムは**2つのプロトコル**を使用します：

- **TCP (ポート 8888)**: 信頼性の高い制御操作（ルーム作成/参加/一覧表示）
- **UDP (ポート 8889)**: 高速リアルタイムメッセージング

この分離により、重要なルーム管理操作は確実に配信され、チャットメッセージは速度と低遅延を優先します。

## ファイル構成

```
online_chat_messenger/
├── client.py          # クライアントアプリケーション
├── server.py          # サーバーアプリケーション
└── README.md          # プロジェクトドキュメント
```

## 使用方法

### サーバー起動

```bash
python server.py
```

サーバーは以下のポートで起動します：
- TCP制御サーバー: ポート 8888
- UDPメッセージサーバー: ポート 8889

### クライアント起動

```bash
python client.py
```

クライアント起動後、以下のメニューが表示されます：

```
チャットアプリケーションを起動します
クライアントID: [プロセスID]
--------------------------------
1. ルームを作成する
2. ルームに参加する
3. ルームを一覧表示する
4. 終了する
--------------------------------
```

### 操作手順

1. **ルーム作成**: メニューで「1」を選択し、ルーム名とユーザー名を入力
2. **ルーム参加**: メニューで「2」を選択し、既存のルーム名とユーザー名を入力
3. **ルーム一覧**: メニューで「3」を選択してアクティブなルーム一覧を表示
4. **チャット**: ルーム作成/参加後、メッセージを入力してEnterキーで送信
5. **退出**: チャット中に `/quit` と入力してルームから退出

## 主要クラスとメソッド

### ChatClient クラス (client.py)

クライアント側の全機能を管理するメインクラス。

#### 主要メソッド

- `start()`: アプリケーションのメインループとメニューシステム
- `_create_room()`: TCPを使用してルーム作成リクエストを送信
- `_join_room()`: TCPを使用してルーム参加リクエストを送信
- `_list_rooms()`: TCPを使用してルーム一覧リクエストを送信
- `_start_udp_chat()`: リアルタイムメッセージングセッションを開始
- `_send_udp_message()`: UDPメッセージを送信
- `_receve_udp_message()`: UDPメッセージを受信（別スレッドで実行）
- `_setup_udp_socket()`: UDPソケットを作成し、ポート番号を自動割り当て

#### 重要な属性

- `token`: サーバーから発行される認証トークン（UUID4）
- `room_name`: 参加中のルーム名
- `username`: チャット表示用のユーザー名
- `my_udp_port`: 自動割り当てされたUDPポート番号
- `is_client_running`: UDPメッセージ受信ループの制御フラグ

### ChatServer クラス (server.py)

サーバー側の全機能を統括するメインクラス。

#### 主要メソッド

- `server_start()`: TCPとUDPサーバーを別スレッドで起動
- `_tcp_server()`: TCP制御サーバーを実行
- `_handle_tcp_client()`: 個別のTCPクライアント接続を処理
- `_udp_server()`: UDPメッセージサーバーを実行
- `_relay_message()`: ルーム内の他のユーザーにメッセージを中継
- `_create_room()`: 新しいChatRoomインスタンスを作成
- `_join_room()`: 既存のChatRoomにユーザーを追加
- `_list_rooms()`: アクティブなルーム一覧を返す

#### 重要な属性

- `chat_rooms`: ルーム名をキーとするChatRoomオブジェクトの辞書
- `client_addresses`: ユーザートークンをネットワークアドレスにマッピング
- `is_server_running`: サーバー実行状態の制御フラグ

### ChatRoom クラス (server.py)

個別のチャットルームの状態とユーザー管理を担当。

#### 主要メソッド

- `add_user()`: ルームにユーザーを追加
- `remove_user()`: ルームからユーザーを削除
- `is_host()`: 指定されたトークンがホストかどうか確認
- `validated_token()`: トークンとIPアドレスの認証
- `get_udp_sender_address()`: トークンに対応するUDPアドレスを取得

#### 重要な属性

- `room_name`: ルーム名
- `host_token`: ルーム作成者のホストトークン
- `tokens`: ユーザートークンを(ユーザー名, IP, ポート)のタプルにマッピング
- `created_at`: ルーム作成時刻

## プロトコル仕様

### TCP制御プロトコル

#### ヘッダー形式（32バイト固定長）

```
バイト 0    : ルーム名サイズ（1バイト）
バイト 1    : 操作タイプ（1バイト）
           1 = ルーム作成
           2 = ルーム参加  
           3 = ルーム一覧表示
バイト 2    : 状態（1バイト）
           0 = リクエスト
           1 = エラー
           2 = 成功
バイト 3-31 : ペイロードサイズ（29バイト、ビッグエンディアン）
```

#### ボディ形式

```
ルーム名（UTF-8エンコード）
ペイロードデータ（JSON形式、UTF-8エンコード）
```

#### ペイロードデータ例

```json
{
    "user_name": "ユーザー名",
    "udp_port": 12345
}
```

### UDPメッセージプロトコル

#### パケット形式

```
バイト 0        : ルーム名サイズ（1バイト）
バイト 1        : トークンサイズ（1バイト）
バイト 2-N      : ルーム名（UTF-8エンコード）
バイト N+1-M    : トークン（UTF-8エンコード）
バイト M+1-末尾 : メッセージ（UTF-8エンコード）
```

## 認証システム

システムはUUID4ベースのトークン認証を使用します：

1. **トークン生成**: ルーム作成/参加時にサーバーがUUID4トークンを生成
2. **トークン検証**: UDPメッセージ送信時にトークンとIPアドレスを検証
3. **ホスト権限**: ルーム作成者は特別なホストトークンを受け取り、ルーム管理権限を持つ
4. **セキュリティ**: トークンは発行時のIPアドレスと紐づけられ、不正使用を防止

## 特殊コマンド

### /quit コマンド

チャット中に `/quit` と入力することでルームから退出できます：

- **一般ユーザー**: 自分のみがルームから退出し、他のユーザーに退出通知が送信される
- **ホストユーザー**: ルーム全体が閉じられ、全参加者に終了通知が送信される

## エラーハンドリング

システムは以下のエラー状況を適切に処理します：

- **TCP接続エラー**: サーバー未起動時の接続失敗
- **UDP通信エラー**: メッセージ送受信の失敗
- **認証エラー**: 無効なトークンやIPアドレス不一致
- **ルーム管理エラー**: 存在しないルームへの参加試行
- **ネットワークエラー**: ソケット操作の例外処理

## 技術的特徴

### マルチスレッド処理

- **サーバー**: TCPとUDPサーバーが独立したスレッドで動作
- **クライアント**: メッセージ受信が専用スレッドで非同期実行
- **並行処理**: 複数クライアントの同時接続をサポート

### メモリ管理

- **動的ポート割り当て**: クライアントUDPポートの自動割り当て
- **リソース解放**: ソケットとスレッドの適切なクリーンアップ
- **状態管理**: ルームとユーザー情報の効率的な管理

### 拡張性

- **設定可能ポート**: TCP/UDPポート番号をコンストラクタで指定可能
- **モジュラー設計**: クラス分離による保守性の向上
- **プロトコル拡張**: 新しい操作タイプの追加が容易

## 開発者向け情報

### デバッグ機能

コード内にデバッグ用のprint文が含まれており、以下の情報を出力します：

- 受信したTCP/UDPデータの詳細
- ルーム作成/参加/退出のログ
- エラー発生時の詳細情報

### カスタマイズポイント

- **ポート番号**: ChatClientとChatServerのコンストラクタで変更可能
- **メッセージ形式**: _relay_messageメソッドでフォーマットをカスタマイズ
- **認証方式**: validated_tokenメソッドで認証ロジックを拡張可能

## 依存関係

標準ライブラリのみを使用：

- `socket`: TCP/UDP通信
- `threading`: マルチスレッド処理
- `json`: データシリアライゼーション
- `uuid`: ユニークトークン生成
- `time`: タイムスタンプ管理
- `typing`: 型ヒント

## ライセンス

このプロジェクトのライセンス情報については、リポジトリの管理者にお問い合わせください。
